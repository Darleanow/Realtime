<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Minimal Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ---------- Global ---------- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Inter", sans-serif;
        background: #0d1117;
        color: #e6edf3;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 40px 0;
      }

      #chat-container {
        width: 92%;
        max-width: 950px;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      header {
        background: #1f6feb;
        color: white;
        padding: 16px 20px;
        font-size: 1.2rem;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      main {
        display: flex;
        height: 600px;
      }

      /* ---------- Sidebar ---------- */
      #sidebar {
        width: 230px;
        background: #0d1117;
        border-right: 1px solid #30363d;
        padding: 16px;
        display: flex;
        flex-direction: column;
      }

      #sidebar h4 {
        font-size: 0.85rem;
        font-weight: 600;
        color: #8b949e;
        margin-bottom: 8px;
      }

      #user-list {
        list-style: none;
        flex: 1;
        overflow-y: auto;
        margin-bottom: 24px;
      }

      #user-list li {
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        color: #c9d1d9;
        transition: background 0.15s;
      }

      #user-list li:hover {
        background: #21262d;
      }
      #user-list li.self {
        background: #1f6feb33;
        color: #58a6ff;
        font-weight: 600;
      }

      #new-room-input {
        background: #0d1117;
        color: #c9d1d9;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 8px;
        font-size: 0.9rem;
        margin-bottom: 8px;
        outline: none;
      }

      #change-room-btn {
        background: #238636;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
      }

      #change-room-btn:hover {
        background: #2ea043;
      }

      /* ---------- Chat Area ---------- */
      #chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }

      #chat-header {
        margin-bottom: 12px;
        font-size: 0.95rem;
        font-weight: 500;
        color: #8b949e;
      }

      #messages {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #30363d;
        border-radius: 8px;
        background: #0d1117;
        padding: 12px;
        margin-bottom: 12px;
        scrollbar-width: thin;
        scrollbar-color: #30363d transparent;
      }

      #messages li {
        margin-bottom: 10px;
        line-height: 1.5;
        word-wrap: break-word;
      }

      #messages li strong {
        color: #58a6ff;
      }
      #messages li.system {
        color: #8b949e;
        font-style: italic;
        text-align: center;
      }
      #messages li.private {
        background: #272e38;
        border-left: 3px solid #f0ad4e;
        border-radius: 6px;
        padding: 6px 8px;
      }

      #form-chat {
        display: flex;
        gap: 8px;
      }

      #message-input {
        flex: 1;
        border: 1px solid #30363d;
        border-radius: 8px;
        background: #0d1117;
        color: #e6edf3;
        padding: 10px;
        font-size: 1rem;
        outline: none;
      }

      #form-chat button {
        background: #1f6feb;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
      }

      #form-chat button:hover {
        background: #388bfd;
      }

      /* ---------- Join Section ---------- */
      #join-section {
        padding: 40px;
        text-align: center;
      }

      #join-section form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 300px;
        margin: 0 auto;
      }

      #join-section input {
        background: #0d1117;
        color: #e6edf3;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 10px;
        font-size: 1rem;
        outline: none;
      }

      #join-section button {
        background: #1f6feb;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
      }

      #join-section button:hover {
        background: #388bfd;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="chat-container">
      <header>Minimal Chat</header>

      <div id="join-section">
        <form id="form-join">
          <input id="username-input" placeholder="Username" required />
          <input id="room-input" placeholder="Room (e.g. general)" required />
          <button type="submit">Join</button>
        </form>
      </div>

      <main id="chat-section" class="hidden">
        <aside id="sidebar">
          <h4>Online Users</h4>
          <ul id="user-list"></ul>
          <h4>Switch Room</h4>
          <input id="new-room-input" placeholder="New room name..." />
          <button id="change-room-btn">Change</button>
        </aside>

        <section id="chat-area">
          <div id="chat-header">
            Room: <strong id="current-room-display"></strong>
          </div>
          <ul id="messages"></ul>
          <form id="form-chat">
            <input
              id="message-input"
              autocomplete="off"
              placeholder="Type a message..."
            />
            <button>Send</button>
          </form>
        </section>
      </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const joinSection = document.getElementById("join-section");
      const chatSection = document.getElementById("chat-section");
      const formJoin = document.getElementById("form-join");
      const usernameInput = document.getElementById("username-input");
      const roomInput = document.getElementById("room-input");
      const currentRoomDisplay = document.getElementById(
        "current-room-display"
      );
      const userList = document.getElementById("user-list");
      const newRoomInput = document.getElementById("new-room-input");
      const changeRoomBtn = document.getElementById("change-room-btn");
      const messages = document.getElementById("messages");
      const formChat = document.getElementById("form-chat");
      const messageInput = document.getElementById("message-input");

      let username = "",
        room = "";

      formJoin.addEventListener("submit", (e) => {
        e.preventDefault();
        username = usernameInput.value.trim();
        room = roomInput.value.trim();
        if (!username || !room) return;
        socket.emit("join room", { username, room });
        currentRoomDisplay.textContent = room;
        joinSection.classList.add("hidden");
        chatSection.classList.remove("hidden");
      });

      changeRoomBtn.addEventListener("click", () => {
        const newRoom = newRoomInput.value.trim();
        if (!newRoom) return;
        socket.emit("change room", newRoom);
        room = newRoom;
        currentRoomDisplay.textContent = newRoom;
        messages.innerHTML = "";
        newRoomInput.value = "";
      });

      formChat.addEventListener("submit", (e) => {
        e.preventDefault();
        const msg = messageInput.value.trim();
        if (!msg) return;
        // Private message syntax: /w username message
        if (msg.startsWith("/w ")) {
          const [_, to, ...rest] = msg.split(" ");
          socket.emit("private message", {
            from: username,
            to,
            message: rest.join(" "),
          });
        } else {
          socket.emit("chat message", { username, room, message: msg });
        }
        messageInput.value = "";
      });

      socket.on("chat message", ({ username, message, timestamp }) => {
        const li = document.createElement("li");
        const time = new Date(timestamp).toLocaleTimeString();
        li.innerHTML = `<strong>${username}</strong> <small>[${time}]</small>: ${message}`;
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
      });

      socket.on("room message", ({ message }) => {
        const li = document.createElement("li");
        li.classList.add("system");
        li.textContent = message;
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
      });

      socket.on("chat history", (history) => {
        messages.innerHTML = "";
        history.forEach(({ username, message, timestamp }) => {
          const li = document.createElement("li");
          const time = new Date(timestamp).toLocaleTimeString();
          li.innerHTML = `<strong>${username}</strong> <small>[${time}]</small>: ${message}`;
          messages.appendChild(li);
        });
        messages.scrollTop = messages.scrollHeight;
      });

      socket.on("user list", (list) => {
        userList.innerHTML = "";
        list.forEach((u) => {
          const li = document.createElement("li");
          li.textContent = u;
          if (u === username) li.classList.add("self");
          userList.appendChild(li);
        });
      });

      socket.on("private message", ({ from, message }) => {
        const li = document.createElement("li");
        li.classList.add("private");
        li.innerHTML = `<strong>Private from ${from}</strong>: ${message}`;
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
      });
    </script>
  </body>
</html>
